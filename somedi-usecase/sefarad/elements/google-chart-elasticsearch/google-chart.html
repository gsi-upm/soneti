<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/google-apis/google-legacy-loader.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/maps-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<!--
`google-chart` encapsulates Google Charts as a web component, allowing you to easily visualize
data. From simple line charts to complex hierarchical tree maps, the chart element provides a
number of ready-to-use chart types.
    <google-chart
      type='pie'
      options='{"title": "Distribution of days in 2001Q1"}'
      cols='[{"label":"Month", "type":"string"}, {"label":"Days", "type":"number"}]'
      rows='[["Jan", 31],["Feb", 28],["Mar", 31]]'>
    </google-chart>
Height and width are specified as style attributes:
    google-chart {
      height: 300px;
      width: 50em;
    }
Data can be provided in one of three ways:
- Via the `cols` and `rows` attributes:
      cols='[{"label":"Mth", "type":"string"}, {"label":"Days", "type":"number"}]'
      rows='[["Jan", 31],["Feb", 28],["Mar", 31]]'
- Via the `data` attribute, passing in the data directly:
      data='[["Month", "Days"], ["Jan", 31], ["Feb", 28], ["Mar", 31]]'
- Via the `data` attribute, passing in the URL to a resource containing the
  data, in JSON format:
      data='http://example.com/chart-data.json'
@demo
-->
<dom-module id="google-chart">
<style is="custom-style">
  @import url("../../styles/app-theme.html");
</style>
<link rel="import" type="css" href="google-chart.css">
<template>
  <paper-material elevation="1">
    <div class="top-bar">
      <iron-icon icon="{{icon}}"></iron-icon>
      <span>{{options.title}}</span>
    </div>
    <div id="nodata">No entries match the current filters</div>
    <iron-ajax id="ajax" handle-as="json" url="{{data}}"
    on-response="_externalDataLoaded"></iron-ajax>
    <div id="chartdiv" on-tap="makezoom"></div>
    <google-legacy-loader on-api-load="_readyForAction"></google-legacy-loader>

    <div style="float:right">
      <small>Clear Filters</small>
      <paper-icon-button icon="delete" alt="menu" class="green" on-tap="removeFilters"></paper-icon-button>
    </div>
    <div style="width:100%; clear: both"></div>
  </paper-material>
</template>
</dom-module>

<script>
  var filtered = false;
  (function() {
    "use strict";
    Polymer({
      is: 'google-chart',
    /**
     * Fired when the graph is displayed.
     *
     * @event google-chart-render
     */
    /**
     * Fired when the user makes a selection in the chart.
     *
     * @event google-chart-select
     * @param {object} detail
     *   @param {array} detail.selection The user-defined selection.
     */
     properties: {
      /**
       * Sets the type of the chart.
       *
       * Should be one of:
       * - `area`, `bar`, `bubble`, `candlestick`, `column`, `combo`, `geo`,
       *   `histogram`, `line`, `pie`, `scatter`, `stepped-area`, `treemap`
       *
       * See <a href="https://google-developers.appspot.com/chart/interactive/docs/gallery">Google Visualization API reference (Chart Gallery)</a> for details.
       *
       */
       type: {
        type: String,
        value: 'column',
        observer: '_typeChanged'
      },
      data: {
        type: Object,
        observer: '_dataChanged'              
      },
      /**
       * Sets the options for the chart.
       *
       * Example:
       * <pre>{
       *   title: "Chart title goes here",
       *   hAxis: {title: "Categories"},
       *   vAxis: {title: "Values", minValue: 0, maxValue: 2},
       *   legend: "none"
       * };</pre>
       * See <a href="https://google-developers.appspot.com/chart/interactive/docs/gallery">Google Visualization API reference (Chart Gallery)</a>
       * for the options available to each chart type.
       *
       */
       options: {
        type: Object,
        value: function() { return {}; }
      },
      optionsbi: {
        type: Object,
        value: function() { return {}; }
      },
      intvalue:{
        type: Number,
        value: 0
      },
      /**
       * Sets the data columns for this object.
       *
       * When specifying data with `cols` you must also specify `rows`, and
       * not specify `data`.
       *
       * Example:
       * <pre>[{label: "Categories", type: "string"},
       *  {label: "Value", type: "number"}]</pre>
       * See <a href="https://google-developers.appspot.com/chart/interactive/docs/reference#DataTable_addColumn">Google Visualization API reference (addColumn)</a>
       * for column definition format.
       *
       * @attribute cols
       * @type array
       */
       cols: {
        type: Array,
        value: function() { return []; }
      },
      /**
       * Sets the data rows for this object.
       *
       * When specifying data with `rows` you must also specify `cols`, and
       * not specify `data`.
       *
       * Example:
       * <pre>[["Category 1", 1.0],
       *  ["Category 2", 1.1]]</pre>
       * See <a href="https://google-developers.appspot.com/chart/interactive/docs/reference#addrow">Google Visualization API reference (addRow)</a>
       * for row format.
       *
       * @attribute rows
       * @type array
       */
       rows: {
        type: Array,
        value: function() { return []; }
      },
      /**
       * Sets the entire dataset for this object.
       * Can be used to provide the data directly, or to provide a URL from
       * which to request the data.
       *
       * The data format can be a two-dimensional array or the DataTable format
       * expected by Google Charts.
       * See <a href="https://google-developers.appspot.com/chart/interactive/docs/reference#DataTable">Google Visualization API reference (eataTable constructor)</a>
       * for data table format details.
       *
       * When specifying data with `data` you must not specify `cols` or `rows`.
       *
       * Example:
       * <pre>[["Categories", "Value"],
       *  ["Category 1", 1.0],
       *  ["Category 2", 1.1]]</pre>
       *
       * @attribute data
       * @type array, object, or string
       */
      /**
       * Selected datapoint(s) in the map.
       *
       * An array of objects, each with a numeric row and/or column property.
       * `row` and `column` are the zero-based row or column number of an item
       * in the data table to select.
       *
       * To select a whole column, set row to null;
       * to select a whole row, set column to null.
       *
       * Example:
       * <pre>
       *   [{row:0,column:1}, {row:1, column:null}]
       * </pre>
       *
       * @attribute selection
       * @type array
       */
      selection: {
        type: Array,
        value: function() { return []; },
        observer: '_selectionChanged'
      },

      query: {
        type: String,
        observer: '_queryChanged'
      },

      index: {
        type: String
      },

      subindex: {
        type: String
      },

      extraId: {
        type: String
      },

      fields: {
        type: Array,
        value: function() { return []; }
      },

      field: {
        type: String
      },

      host: {
        type: String
      },

      icon: {
        type: String
      },

      param: {
        type: String,
        notify: true
      },

      filters: {
        type: Array,
        notify: true,
        value: function() { return []; }
      }, 
      isSelected: {
        type: Boolean,
        value: false
      }
    },

    _packages: null,
    _chartObject: null,
    _isReady: false,
    _canDraw: false,
    _dataTable: null,
    _chartTypes: null,
    _readyForAction: function(e, detail, sender) {
      this._loadPackageByChartType();
      google.load("visualization", "1", {
        packages: this._packages[this.type],
        callback: function() {
          this._isReady = true;
          this._loadChartTypes();
          this._loadData();
        }.bind(this)
      });
    },

    _typeChanged: function() {
      // Invalidate current chart object.
      this._chartObject = null;
      this._loadData();
    },
    makezoom: function(){
      //console.log("touched");
      //console.log(this.rows);
      //console.log(this.cols);
      //console.log(this.$.chartdiv.firstChild.firstChild.firstChild.firstChild);
      //console.log(this.$.chartdiv.firstChild.firstChild.firstChild.firstChild.querySelector('g'));
    },

    _selectionChanged: function() {
      //console.log("_selectionChanged")
      //console.log(this.selection)
      if(this.selection.length != 0){
        var arr = this.rows;
        var sel = this.selection[0].row
        this.param = arr[sel][0]
        var param = this.param
        var field = this.field
        var term1 = {};
        if (field == "sentiment") field = 'sentiments.marl:hasPolarity'
        if (field == "emotion") field = 'emotions.onyx:hasEmotion.onyx:hasEmotionCategory'
        //console.log(param)
        if (field == 'schema:datePublished'){
          //term1[field] = param.toLowerCase().split("-");
          object = {range: {'schema:datePublished': {gte: param, boost: 5}}}
        }
        else{
          term1[field] = param.toLowerCase().split(" ");
        }
        //console.log(term1)
        var object = {terms: term1}
        
        if (field == 'schema:datePublished'){
          object = {range: {'schema:datePublished': {gte: param, boost: 5}}}
           /*var date = param.toLowerCase().toString().split("-");
           var term = date[1]+'-'+date[0]+'-01'
           object = {range: {'schema:datePublished': {lte: term, boost: 5}}}*/
        }
        var isInside = -1
        for(var i = 0; i < this.filters.length; i++){
          if(JSON.stringify(this.filters[i].term) === JSON.stringify(term1))
              isInside = i
        }
        if(isInside == -1){
          this.push('filters', object)
          this.isSelected = true
        }
      } else {
        if(this.isSelected)
          for(var i = 0; i < this.filters.length; i++){
            if(Object.keys(this.filters[i].term)[0] === this.field){
              this.filters.splice(i,1)
              this.isSelected = false
            }
          }
      }
      //console.log(this.filters)
    },

    ready: function() {
      //console.log(this.optionsbi)

      this.type == 'table' ? this.$.chartdiv.style.margin = '2% 0 2% 33%' : undefined
    },

    removeFilters: function(){
      this.filters = [];
      this.selection = [];
    },

    /**
     * Draws the chart.
     *
     * Called automatically on first load and whenever one of the attributes
     * changes. Can be called manually to handle e.g. page resizes.
     *
     * @method drawChart
     * @return {Object} Returns null.
     */
     drawChart: function() {
      //console.log("inside drawing")
      if (this._canDraw) {
        if (!this.options) {
          this.options = {};
        }
        if (!this._chartObject) {
          var chartClass = this._chartTypes[this.type];
          if (chartClass) {
            this._chartObject = new chartClass(this.$.chartdiv)
            //console.log(this._chartObject)
          }
        }
      }
      this._enableobserver();
      return null;
    },

    _enableobserver: function(){
      if (this._chartObject) {
        google.visualization.events.addOneTimeListener(this._chartObject,
            'ready', function() {
              this.fire('google-chart-render');
            }.bind(this));
          google.visualization.events.addListener(this._chartObject,
            'select', function() {
              //console.log("seleccionando")
              this.selection = this._chartObject.getSelection();
              this.fire('google-chart-select',
                { selection: this._chartObject.getSelection() });
            }.bind(this));
          this._chartObject.draw(this._dataTable, this.optionsbi);
      } else {
          this.$.chartdiv.innerHTML = 'Undefined chart type';
      }

    },

    _loadChartTypes: function() {
      this._chartTypes = {
        'area': google.visualization.AreaChart,
        'bar': google.visualization.BarChart,
        'bubble': google.visualization.BubbleChart,
        'candlestick': google.visualization.CandlestickChart,
        'column': google.visualization.ColumnChart,
        'combo': google.visualization.ComboChart,
        'geo': google.visualization.GeoChart,
        'histogram': google.visualization.Histogram,
        'line': google.visualization.LineChart,
        'pie': google.visualization.PieChart,
        'scatter': google.visualization.ScatterChart,
        'stepped-area': google.visualization.SteppedAreaChart,
        'table': google.visualization.Table,
        'gauge': google.visualization.Gauge,
        'treemap': google.visualization.TreeMap
      };
    },

    _loadPackageByChartType: function() {
      this._packages = {
        'area': 'corechart',
        'bar': 'corechart',
        'bubble': 'corechart',
        'candlestick': 'corechart',
        'column': 'corechart',
        'combo': 'corechart',
        'geo': 'corechart',
        'histogram': 'corechart',
        'line': 'corechart',
        'pie': 'corechart',
        'scatter': 'corechart',
        'stepped-area': 'corechart',
        'table': 'table',
        'gauge': 'gauge',
        'treemap': 'treemap'
      };
    },

    _loadData: function() {
      //console.log("dataloaded")
      this._canDraw = false;
      if (this._isReady) {
        if (typeof this.data == 'string' || this.data instanceof String) {
          // Load data asynchronously, from external URL.
          this.$.ajax.generateRequest();
        } else {
          var dataTable = this._createDataTable();
          this._canDraw = true;
          if (dataTable) {
            this._dataTable = dataTable;
            //console.log(this.intvalue)
            if (this.intvalue == 0){
              this.drawChart();
              this.intvalue++
            }
            if(this.intvalue != 0){
              //console.log(this._dataTable)
              this._chartObject.draw(this._dataTable, this.optionsbi);
            }
          }
        }
      }
    },

    _externalDataLoaded: function(e) {
      var dataTable = this._createDataTable(e.detail.response);
      this._canDraw = true;
      this._dataTable = dataTable;
      this.drawChart();
    },

    _createDataTable: function(data) {
      var dataTable = null;
      // If a data object was not passed to this function, default to the
      // chart's data attribute. Passing a data object is necessary for
      // cases when the data attribute is a URL pointing to an external
      // data source.
      if (!data) {
        data = this.data;
      }
      if (!data)
        data = [];
      if (this.rows && this.rows.length > 0 && this.cols &&
        this.cols.length > 0) {
        // Create the data table from cols and rows.
      if (this.field == 'schema:datePublished'){
        var rows = []
        this.rows.forEach(function(entry,index){
            //console.log(entry[0].split('-')[0], entry[0].split('-')[1])
            //console.log(new Date(entry[0].split('-')[0], entry[0].split('-')[1]-1), entry[1])
            //console.log(entry[0])
            rows.push([new Date(entry[0].split('-')[0], entry[0].split('-')[1]-1, entry[0].split('-')[2]), entry[1], entry[2]])
        });
      //console.log(rows)
      this.rows = rows
      }
      dataTable = new google.visualization.DataTable();
      dataTable.cols = this.cols;
      for (var i = 0; i < this.cols.length; i++) {
        //console.log(this.cols[i])
        dataTable.addColumn(this.cols[i]);
      }
      dataTable.addRows(this.rows);
      } else {
        // Create dataTable from the passed data or the data attribute.
        // Data can be in the form of raw DataTable data or a two
        // dimensional array.
        if (data.rows && data.cols) {

          dataTable = new google.visualization.DataTable(data);
        } else if (data.length > 0) {
          console.log(data)
          dataTable = google.visualization.arrayToDataTable(data);
        }
      }
      return dataTable;
    },

    _dataChanged: function() {
      //console.log("_dataChanged")
      //console.log(this.field)
      //console.log(this.data)
      var that = this
      var aggs = 0
      try{
        var hits = this.data.aggregations[this.field].buckets;
      }
      catch(err){
        var hits = []
      }
      
      if (this.field == "schema:datePublished") {
        var datos = {}
        //console.log(this.data)
        this.data.hits.hits.forEach(function(entry) {
          //console.log(entry._source)
          var fecha = entry._source['schema:datePublished'].split('-')
          //console.log(fecha)
          var fechacompleta = fecha[0]+'-'+fecha[1]+'-'+fecha[2].split('T')[0]
          //console.log(fechacompleta)
          if(datos.hasOwnProperty(fechacompleta)){
            if(entry._source['schema:creator'] == 'rest_lateral'){
              if (datos[fechacompleta].hasOwnProperty('propio')){
                datos[fechacompleta]['propio'] = datos[fechacompleta]['propio'] + 1
              } else  datos[fechacompleta]['propio'] = 1
            }
            else if(entry._source['schema:creator'] == 'restauranteslateral'){
               if (datos[fechacompleta].hasOwnProperty('propio')){
                datos[fechacompleta]['propio'] = datos[fechacompleta]['propio'] + 1
              } else  datos[fechacompleta]['propio'] = 1
            }
            else if(entry._source['schema:creator'] != ('rest_lateral' || 'restauranteslateral' || '100montaditos' || '100MontaditosSpain')){
              if (datos[fechacompleta].hasOwnProperty('otro')){
                datos[fechacompleta]['otro'] = datos[fechacompleta]['otro'] + 1
              } else  datos[fechacompleta]['otro'] = 1
            }
            if(entry._source['schema:creator'] == 'restauranteslateral'){
              if (datos[fechacompleta].hasOwnProperty('otro')){
                //console.log( entry._source['comments']['data'].length)
                datos[fechacompleta]['otro'] = datos[fechacompleta]['otro'] + entry._source['comments']['data'].length
              } else  datos[fechacompleta]['otro'] = 1
            }

          }
          else {
            datos[fechacompleta] = {}
            if(entry._source['schema:creator'] == 'rest_lateral'){
              if (datos[fechacompleta].hasOwnProperty('propio')){
                datos[fechacompleta]['propio'] = datos[fechacompleta]['propio'] + 1
              } else  datos[fechacompleta]['propio'] = 1
            }
            else if(entry._source['schema:creator'] == 'restauranteslateral'){
               if (datos[fechacompleta].hasOwnProperty('propio')){
                datos[fechacompleta]['propio'] = datos[fechacompleta]['propio'] + 1
              } else  datos[fechacompleta]['propio'] = 1
            }
            else if(entry._source['schema:creator'] != ('rest_lateral' || 'restauranteslateral' || '100montaditos' || '100MontaditosSpain')){
              if (datos[fechacompleta].hasOwnProperty('otro')){
                datos[fechacompleta]['otro'] = datos[fechacompleta]['otro'] + 1
              } else  datos[fechacompleta]['otro'] = 1
            }
            if(entry._source['schema:creator'] == 'restauranteslateral'){
              if (datos[fechacompleta].hasOwnProperty('otro')){
                //console.log( entry._source['comments']['data'].length)
                datos[fechacompleta]['otro'] = datos[fechacompleta]['otro'] + entry._source['comments']['data'].length
              } else  datos[fechacompleta]['otro'] = 1
            }
          }
        });
        var data = Object.keys(datos).map(function(key) {

           if (datos[key]['propio'] != undefined) var propio = datos[key]['propio']
           else var propio = 0 
           if (datos[key]['otro'] != undefined) var otro = datos[key]['otro']
           else var otro = 0 

          return [key, propio, otro];
        });
        //console.log(data)
      }

      else {
        var data = [];
        hits.forEach(function(entry) {
          data.push([entry.key, entry.doc_count]);
        });
      }
      //console.log(data)
       if(data.length == 0 ){
          this.$.chartdiv.style.visibility = 'hidden';
          this.$.nodata.style.visibility = 'visible';
      } else {
          this.$.chartdiv.style.visibility = 'visible';
          this.$.nodata.style.visibility = 'hidden';
      }

      that.rows = data;
      filtered = true;
      this._loadData();
    }

    
  });
})();
</script>
